<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Entr√©e Mariage Dorcas & Jeft√©</title>
<script src="./html5-qrcode.min.js" type="text/javascript"></script>
<style>
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #ffffff;
    color: #111;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    margin: 20px 0 10px;
    color: #b76e79;
    text-shadow: 0 0 10px rgba(183,110,121,0.5);
  }

  .scanner {
    position: relative;
    width: 90%;
    max-width: 500px;
    height: 400px;
    border: 2px solid #b76e79;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    margin-top: 20px;
  }

  /* Carr√© guide pour le QR code */
  .scanner::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200px;       /* largeur du guide */
    height: 200px;      /* hauteur du guide */
    border: 3px dashed #00ff9c;
    border-radius: 10px;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  .status {
    margin-top: 15px;
    font-weight: bold;
  }

  button {
    margin: 10px;
    background: #b76e79;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
  }

  button:hover {
    background: #a85d6a;
  }

  .scanned-list {
    max-height: 250px;
    overflow-y: auto;
    margin-top: 20px;
    padding: 10px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    background: #f9f9f9;
    border: 1px solid #ccc;
  }

  .scanned-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }

  .scanned-list li input {
    padding: 3px 6px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background: #fff;
    color: #000;
    margin-left: 10px;
    flex: 1;
  }

</style>
</head>
<body>

<h1>SCANNE LES PASS AU MARIAGE<br>DORCAS & JEFT√â üíç</h1>

<div id="reader" class="scanner"></div>

<div class="status" id="status"></div>
<div id="info"></div>
<p id="count">Invit√©s scann√©s : 0</p>
<button onclick="resetScan()">Scanner un autre QR</button>
<button onclick="exportScannedList()">Exporter la liste</button>

<div class="scanned-list">
  <h3>Invit√©s scann√©s :</h3>
  <ul id="scannedList"></ul>
</div>

<audio id="sound-valid" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_bdb3c98d8d.mp3?filename=correct-2-46134.mp3"></audio>
<audio id="sound-error" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_28298b3dbf.mp3?filename=error-2-126514.mp3"></audio>

<script>
const invitesAutorises = [
  { nom: "Naomi", personnes: 1, table: 3 },
  { nom: "Couple Maro", personnes: 2, table: 3 },
  { nom: "Couple J√©suane", personnes: 2, table: 3 },
  { nom: "Dicap's", personnes: 2, table: 3 },
  { nom: "Ritchy", personnes: 1, table: 3 },
  { nom: "Ivana", personnes: 1, table: 3 }
];

const normalize = str => str.trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
const scanned = JSON.parse(localStorage.getItem("scannedList") || "[]");
scanned.forEach(s => addToList(s));
updateCount();

let lastScanned = "";
let lastScanTime = 0;

function resetScan() {
  document.getElementById("status").innerText = "";
  document.getElementById("info").innerText = "";
}

function updateCount() {
  document.getElementById("count").innerText = `Invit√©s scann√©s : ${scanned.length}`;
}

function addToList(invite) {
  const ul = document.getElementById("scannedList");
  const li = document.createElement("li");
  const infoSpan = document.createElement("span");
  infoSpan.textContent = `‚úÖ ${invite.nom} - ${invite.personnes} pers. - Table ${invite.table}`;
  const commentInput = document.createElement("input");
  commentInput.type = "text";
  commentInput.placeholder = "Commentaires...";
  commentInput.value = invite.comment || "";
  commentInput.addEventListener("input", () => {
    invite.comment = commentInput.value;
    localStorage.setItem("scannedList", JSON.stringify(scanned));
  });
  li.appendChild(infoSpan);
  li.appendChild(commentInput);
  ul.appendChild(li);
}

function handleScan(decodedText) {
  const now = Date.now();
  if (decodedText === lastScanned && now - lastScanTime < 3000) return;
  lastScanned = decodedText;
  lastScanTime = now;

  const successSound = document.getElementById("sound-valid");
  const errorSound = document.getElementById("sound-error");
  const status = document.getElementById("status");
  const info = document.getElementById("info");

  try {
    const data = JSON.parse(decodedText);
    const nomNorm = normalize(data.nom);
    const already = scanned.find(s => normalize(s.nom) === nomNorm);
    const valid = invitesAutorises.find(i => normalize(i.nom) === nomNorm && i.personnes == data.personnes && i.table == data.table);

    if (already) {
      status.innerText = `‚úÖ ${already.nom} est de retour !`;
      status.className = "ok";
      successSound.play();
      info.innerHTML = `<p><strong>Nom :</strong> ${already.nom}</p><p><strong>Personnes :</strong> ${already.personnes}</p><p><strong>Table :</strong> ${already.table}</p>`;
      return;
    } else if (valid) {
      status.innerText = "‚úÖ Invitation valide ! Bienvenue üéâ";
      status.className = "ok";
      successSound.play();
      data.comment = "";
      scanned.push(data);
      localStorage.setItem("scannedList", JSON.stringify(scanned));
      info.innerHTML = `<p><strong>Nom :</strong> ${data.nom}</p><p><strong>Personnes :</strong> ${data.personnes}</p><p><strong>Table :</strong> ${data.table}</p>`;
      addToList(data);
      updateCount();
    } else {
      status.innerText = "‚ùå Invitation non reconnue";
      status.className = "invalid";
      errorSound.play();
    }
  } catch {
    status.innerText = "QR invalide";
    status.className = "invalid";
    errorSound.play();
  }
}

function exportScannedList() {
  if(scanned.length === 0) {
    alert("Aucun invit√© scann√© pour exporter !");
    return;
  }
  const csvContent = "Nom,Personnes,Table,Commentaires\n" +
    scanned.map(i => `${i.nom},${i.personnes},${i.table},${i.comment || ""}`).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "invites_scannes.csv");
  link.click();
}

// Initialiser le scanner QR
Html5Qrcode.getCameras().then(cameras => {
  if (cameras && cameras.length) {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      handleScan
    );
  } else {
    alert("Aucune cam√©ra trouv√©e");
  }
}).catch(err => console.error(err));
</script>
</body>
</html>
